# Phone to Present CC - Workflow Graph
# Traversal logic for claude.md orchestrator

graph:
  name: "phone_to_present_cc"
  version: "1.0.0"
  orchestrator: "claude.md"

start_node: "preflight"
terminal_nodes: ["success", "failure", "blocked"]

# ════════════════════════════════════════════════════════════════════
# NODES - Each phase is a node
# ════════════════════════════════════════════════════════════════════

nodes:
  # ──────────────────────────────────────────────────────────────────
  # PHASE 0: Pre-flight
  # ──────────────────────────────────────────────────────────────────
  - id: "preflight"
    stage: "preflight"
    purpose: "Validate templates, references, config exist before starting"
    instructions: |
      1. Check templates/presentation_template.md exists
      2. Check it contains class="pf-table" (v4 HTML)
      3. Check references/slide18_paths_forward_v4.md exists
      4. Load config/pricing_constants.yaml
      5. Update state.preflight.*
    gate:
      field: "preflight.all_checks_passed"
      on_pass: "discovery"
      on_fail: "blocked"

  # ──────────────────────────────────────────────────────────────────
  # PHASE 1: Discovery
  # ──────────────────────────────────────────────────────────────────
  - id: "discovery"
    stage: "discovery"
    purpose: "Find data files, gather client info, confirm business hours"
    instructions_file: "../phone_to_present/workflow/phase1_discovery.md"
    user_interaction: true
    outputs:
      - "client.name"
      - "client.website"
      - "data_file.path"
      - "business_hours.*"
    gate:
      field: "discovery.confirmed"
      on_pass: "ingestion"
      on_fail: "discovery"  # Loop until confirmed

  # ──────────────────────────────────────────────────────────────────
  # PHASE 2: Ingestion
  # ──────────────────────────────────────────────────────────────────
  - id: "ingestion"
    stage: "ingestion"
    purpose: "Standardize columns, normalize dispositions, quality checks"
    instructions_file: "../phone_to_present/workflow/phase2_ingestion.md"
    code_required: true
    outputs:
      - "data_file.gold_path"
      - "ingestion.row_count"
      - "ingestion.quality_score"
    gate:
      field: "ingestion.quality_passed"
      on_pass: "analysis"
      on_fail: "ingestion"  # Fix and retry

  # ──────────────────────────────────────────────────────────────────
  # PHASE 3: Analysis
  # ──────────────────────────────────────────────────────────────────
  - id: "analysis"
    stage: "analysis"
    purpose: "Calculate KPIs from OPEN HOURS inbound calls only"
    instructions_file: "../phone_to_present/workflow/phase3_analysis.md"
    code_required: true
    critical_rule: "All metrics computed from OPEN HOURS only"
    outputs:
      - "kpis.ANSWER_RATE"
      - "kpis.MISS_RATE"
      - "kpis.GRADE"
      - "kpis.MISSED_PER_WEEK"
    gate:
      field: "analysis.kpis_computed"
      on_pass: "concurrency"
      on_fail: "analysis"

  # ──────────────────────────────────────────────────────────────────
  # PHASE 4: Concurrency & FTE
  # ──────────────────────────────────────────────────────────────────
  - id: "concurrency"
    stage: "concurrency"
    purpose: "Calculate BASE_FTE via CDF and Monte Carlo, reconcile"
    instructions_file: "../phone_to_present/workflow/phase4_concurrency.md"
    code_required: true
    code_pattern: |
      # MUST write and execute Python:
      # 1. CDF at 90% coverage (exclude level 0)
      # 2. Monte Carlo simulation (deterministic seed)
      # 3. Verify |CDF_FTE - MC_FTE| <= 1.0
    outputs:
      - "concurrency.BASE_FTE"
      - "concurrency.MC_FTE_90"
      - "concurrency.SHRINKAGE_FTE"
    stop_condition:
      check: "abs(BASE_FTE - MC_FTE_90) > 1.0"
      action: "STOP and reconcile"
    gate:
      field: "concurrency.fte_reconciled"
      on_pass: "pricing"
      on_fail: "blocked"

  # ──────────────────────────────────────────────────────────────────
  # PHASE 5: Pricing
  # ──────────────────────────────────────────────────────────────────
  - id: "pricing"
    stage: "pricing"
    purpose: "Calculate all pricing options, apply minimums"
    instructions_file: "../phone_to_present/workflow/phase5_pricing.md"
    code_required: true
    code_pattern: |
      # MUST write and execute Python:
      # 1. Calculate INBOUND = BASE_FTE * $480/week
      # 2. Calculate RHC = SHRINKAGE_FTE * $480/week
      # 3. Apply minimums (Pilot: $600, Inbound/RHC: $480)
      # 4. Log any adjustments
    outputs:
      - "pricing.INBOUND_WEEKLY"
      - "pricing.RHC_WEEKLY"
      - "pricing.PILOT_WEEKLY"
      - "pricing.HIRE_WEEKLY"
    stop_condition:
      check: "calculated < minimum"
      action: "Apply minimum, log adjustment, confirm with user"
    gate:
      field: "pricing.verified"
      on_pass: "charts"
      on_fail: "pricing"

  # ──────────────────────────────────────────────────────────────────
  # PHASE 6: Charts
  # ──────────────────────────────────────────────────────────────────
  - id: "charts"
    stage: "charts"
    purpose: "Generate PNG charts, verify file size > 0"
    instructions_file: "../phone_to_present/workflow/phase6_charts.md"
    code_required: true
    outputs:
      - "charts/*.png"
    verification:
      - "All chart files exist"
      - "All chart files > 1000 bytes"
    gate:
      field: "charts.all_exist"
      on_pass: "presentation"
      on_fail: "charts"

  # ──────────────────────────────────────────────────────────────────
  # PHASE 7: Presentation
  # ──────────────────────────────────────────────────────────────────
  - id: "presentation"
    stage: "presentation"
    purpose: "Populate template, generate HTML/PPTX"
    instructions_file: "../phone_to_present/workflow/phase7_presentation.md"
    critical_rules:
      - "Slide 18 MUST use v4 HTML (references/slide18_paths_forward_v4.md)"
      - "Zero unreplaced {{PLACEHOLDER}} tokens"
      - "No FTE numbers adjacent to prices"
    outputs:
      - "presentation.md"
      - "presentation.html"
      - "presentation.pptx"
    gate:
      field: "presentation.placeholders_zero"
      on_pass: "qa"
      on_fail: "presentation"

  # ──────────────────────────────────────────────────────────────────
  # PHASE 7b: QA
  # ──────────────────────────────────────────────────────────────────
  - id: "qa"
    stage: "qa"
    purpose: "Visual verification of critical slides"
    instructions_file: "../phone_to_present/workflow/phase7b_presentation_qa.md"
    critical_slides: [1, 5, 8, 18]
    checks:
      - "No white-on-white text"
      - "Margins on all sides"
      - "All images load"
      - "Slide 18 is v4 HTML (not markdown)"
    gate:
      field: "qa.all_pass"
      on_pass: "deliverables"
      on_fail: "presentation"  # Fix and re-render

  # ──────────────────────────────────────────────────────────────────
  # PHASE 8: Deliverables
  # ──────────────────────────────────────────────────────────────────
  - id: "deliverables"
    stage: "deliverables"
    purpose: "Output summary, list all generated files"
    instructions_file: "../phone_to_present/workflow/phase8_deliverables.md"
    outputs:
      - "gold_calls.csv"
      - "analysis_manifest.json"
      - "charts/"
      - "presentation.md"
      - "presentation.html"
      - "presentation.pptx"
    gate:
      field: "deliverables.complete"
      on_pass: "success"
      on_fail: "deliverables"

  # ──────────────────────────────────────────────────────────────────
  # Terminal Nodes
  # ──────────────────────────────────────────────────────────────────
  - id: "success"
    stage: "complete"
    terminal: true
    outcome: "success"

  - id: "failure"
    stage: "complete"
    terminal: true
    outcome: "failure"

  - id: "blocked"
    stage: "blocked"
    terminal: true
    outcome: "blocked"
    action: "Ask user for resolution"

# ════════════════════════════════════════════════════════════════════
# EDGES - Transitions between nodes
# ════════════════════════════════════════════════════════════════════

edges:
  # Pre-flight
  - from: "preflight"
    to: "discovery"
    guard: "state.preflight.all_checks_passed == true"

  - from: "preflight"
    to: "blocked"
    guard: "state.preflight.all_checks_passed == false"

  # Discovery -> Ingestion
  - from: "discovery"
    to: "ingestion"
    guard: "state.discovery.confirmed == true"

  # Ingestion -> Analysis
  - from: "ingestion"
    to: "analysis"
    guard: "state.ingestion.quality_passed == true"

  # Analysis -> Concurrency
  - from: "analysis"
    to: "concurrency"
    guard: "state.analysis.kpis_computed == true"

  # Concurrency -> Pricing
  - from: "concurrency"
    to: "pricing"
    guard: "state.concurrency.fte_reconciled == true"

  - from: "concurrency"
    to: "blocked"
    guard: "abs(state.concurrency.BASE_FTE - state.concurrency.MC_FTE_90) > 1.0"

  # Pricing -> Charts
  - from: "pricing"
    to: "charts"
    guard: "state.pricing.verified == true"

  # Charts -> Presentation
  - from: "charts"
    to: "presentation"
    guard: "state.charts.all_exist == true"

  # Presentation -> QA
  - from: "presentation"
    to: "qa"
    guard: "state.presentation.placeholders_zero == true"

  # QA -> Deliverables (or back to Presentation)
  - from: "qa"
    to: "deliverables"
    guard: "state.qa.all_pass == true"

  - from: "qa"
    to: "presentation"
    guard: "state.qa.all_pass == false"
    max_retries: 3

  # Deliverables -> Success
  - from: "deliverables"
    to: "success"
    guard: "state.deliverables.complete == true"

# ════════════════════════════════════════════════════════════════════
# STOP CONDITIONS - Global halts
# ════════════════════════════════════════════════════════════════════

stop_conditions:
  - condition: "Template missing"
    action: "STOP - DO NOT generate from scratch"

  - condition: "FTE reconciliation fails"
    action: "STOP - calculation error, must fix"

  - condition: "Unknown disposition > 10%"
    action: "STOP - data quality, ask user"

  - condition: "Grade D or F"
    action: "STOP - confirm with user before proceeding"

  - condition: "Chart file size = 0"
    action: "STOP - regenerate chart"
